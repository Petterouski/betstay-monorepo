name: Deploy Booking Domain

on:
  push:
    branches: [ "develop" ] # Ojo: Asegúrate que estás pusheando a develop
    paths:
      - 'apps/booking-engine/**'
      - '.github/workflows/deploy-booking.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: petterouski/betstay-monorepo/booking-engine

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,format=long

      # IMPORTANTE: no-cache para asegurar que tome el nuevo go.mod
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/booking-engine/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          no-cache: true 

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: QA

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          USERNAME: ${{ github.actor }}
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          TAG: ${{ github.sha }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: GHCR_PAT,USERNAME,IMAGE,TAG
          script: |
            echo "--- INICIANDO DESPLIEGUE ---"
            
            # 1. Login
            echo $GHCR_PAT | docker login ghcr.io -u $USERNAME --password-stdin
            
            # 2. Pull
            docker pull $IMAGE:sha-$TAG
            
            # 3. Red
            docker network create betstay-net || true
            
            # 4. LIMPIEZA DE MYSQL (El culpable del error)
            echo "Eliminando MySQL antiguo..."
            docker stop mysql-booking || true
            docker rm mysql-booking || true
            
            # 5. DESPLIEGUE DE POSTGRES (El salvador)
            echo "Verificando PostgreSQL..."
            if [ ! "$(docker ps -q -f name=betstay-postgres)" ]; then
                if [ "$(docker ps -aq -f name=betstay-postgres)" ]; then
                    docker rm betstay-postgres
                fi
                docker run -d \
                  --name betstay-postgres \
                  --network betstay-net \
                  --restart unless-stopped \
                  -e POSTGRES_USER=postgres \
                  -e POSTGRES_PASSWORD=postgres_password \
                  -e POSTGRES_DB=postgres \
                  -p 5432:5432 \
                  postgres:15-alpine
                  
                sleep 10
                # Crear la base de datos booking_db
                docker exec betstay-postgres psql -U postgres -c "CREATE DATABASE booking_db;" || true
            fi
            
            # 6. DESPLIEGUE DE LA APP (Conectada a Postgres)
            echo "Desplegando Booking Engine..."
            docker stop booking-engine || true
            docker rm booking-engine || true
            
            docker run -d \
              --name booking-engine \
              --network betstay-net \
              --restart always \
              -p 3003:3003 \
              -e DB_DRIVER=postgres \
              -e DB_SOURCE="host=betstay-postgres user=postgres password=postgres_password dbname=booking_db port=5432 sslmode=disable" \
              $IMAGE:sha-$TAG
              
            docker image prune -f
            echo "--- DESPLIEGUE FINALIZADO ---"