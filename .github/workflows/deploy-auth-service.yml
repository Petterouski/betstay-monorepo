name: Deploy Auth Service

on:
  push:
    branches: [ "develop", "main" ]  # <--- Â¡IMPORTANTE! Agrega "main"
    paths:
      - 'apps/auth-service/**'
      - 'apps/auth-service/prisma/**'
      - '.github/workflows/deploy-auth-service.yml'
      - 'package.json'
      - 'nx.json'
      - 'sonar-project.properties'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: petterouski/betstay-monorepo/auth-service

jobs:
  quality-check:
    name: SonarCloud Analysis & Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Vital para SonarCloud

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Run Tests with Coverage (Auth Service)
        # Ejecuta tests y genera el lcov.info
        run: npx nx test auth-service --coverage

      # Paso de depuraciÃ³n: Verifica que el archivo existe antes de escanear
      - name: Debug - Verify Coverage File
        run: |
          echo "Buscando archivo lcov.info..."
          find . -name "lcov.info"

      # âœ… ACTUALIZACIÃ“N: Usamos la versiÃ³n v6 oficial para quitar warnings
      - name: SonarQube Cloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

          #with:
          # ðŸ‘‡ AQUÃ ESTÃ LA LÃNEA.
          # Esto le dice al pipeline: "No esperes el resultado (Aprobado/Reprobado)"
          # Si la descomentas, el pipeline se bloquearÃ¡ si no tienes 80% de coverage.
          #args: >
          #  -Dsonar.qualitygate.wait=true

  build-and-push:
    needs: quality-check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,format=long

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/auth-service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: QA
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          USERNAME: ${{ github.actor }}
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          TAG: ${{ github.sha }}
          DATABASE_URL: ${{ secrets.AUTH_DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        with:
          host: ${{ secrets.GATEWAY_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: GHCR_PAT,USERNAME,IMAGE,TAG,DATABASE_URL,JWT_SECRET
          script: |
            echo $GHCR_PAT | docker login ghcr.io -u $USERNAME --password-stdin
            docker pull $IMAGE:sha-$TAG
            docker network create betstay-net || true
            
            echo "Reiniciando auth-service..."
            docker stop auth-service || true
            docker rm auth-service || true
            
            docker run -d \
              --name auth-service \
              --network betstay-net \
              --restart always \
              -p 3001:3001 \
              -e DATABASE_URL=$DATABASE_URL \
              -e JWT_SECRET=$JWT_SECRET \
              -e NODE_ENV=production \
              $IMAGE:sha-$TAG
            
            docker image prune -f