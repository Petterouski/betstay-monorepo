version: '3.8'

services:
  # --- BASE DE DATOS COMPARTIDA ---
  postgres:
    image: postgres:15-alpine
    container_name: betstay-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_password
      POSTGRES_DB: postgres # DB por defecto (las otras se crean con el script)
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker-resources/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - betstay-net

  redis:
    image: redis:alpine
    container_name: betstay-redis
    ports:
      - "6379:6379"
    networks:
      - betstay-net

  # --- MICROSERVICIOS ---

  api-gateway: # NestJS (Puerto 3000)
    build:
      context: .
      dockerfile: ./apps/api-gateway/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - betstay-net

  auth-service: # NestJS (Puerto 3001)
    build:
      context: .
      dockerfile: ./apps/auth-service/Dockerfile
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - DATABASE_URL=postgresql://postgres:postgres_password@postgres:5432/auth_db
      - JWT_SECRET=supersecretjwtkeyfordev123456  # NUEVO
      - NODE_ENV=development                       # NUEVO
    depends_on:
      - postgres
    networks:
      - betstay-net
      # Agregar volúmenes para hot reload en desarrollo
    volumes:
      - ./apps/auth-service:/app/apps/auth-service
      - /app/apps/auth-service/node_modules

  hotel-core: # NestJS (Puerto 3002)
    build:
      context: .
      dockerfile: ./apps/hotel-core/Dockerfile
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - DATABASE_URL=postgresql://postgres:postgres_password@postgres:5432/hotel_db
    depends_on:
      - postgres
    networks:
      - betstay-net

  booking-engine: # Go (Puerto 3003) - AHORA CON POSTGRES
    build:
      context: .
      dockerfile: ./apps/booking-engine/Dockerfile
    ports:
      - "3003:3003"
    environment:
      - DB_DRIVER=postgres
      # Cadena de conexión estilo Postgres para Go
      - DB_SOURCE=host=postgres user=postgres password=postgres_password dbname=booking_db port=5432 sslmode=disable
    depends_on:
      - postgres
    networks:
      - betstay-net

  betting-engine: # Python (Puerto 3006)
    build:
      context: .
      dockerfile: ./apps/betting-engine/Dockerfile
    ports:
      - "3006:3006"
    networks:
      - betstay-net

  # --- NUEVO: FRONTEND ---
  web-client: # Next.js (Puerto Externo 3012 -> Interno 3000)
    build:
      context: .
      dockerfile: ./apps/web-client/Dockerfile
      args:
        # En local, apuntamos al auth-service dentro de la red de docker o localhost
        # Si usas modo híbrido local, usa la IP de AWS aquí también
        - NEXT_PUBLIC_API_URL=http://44.197.107.26:3001/api
    ports:
      - "3012:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://44.197.107.26:3001/api
    networks:
      - betstay-net
    # Opcional: volúmenes si quieres editar frontend en caliente
    volumes:
      - ./apps/web-client:/app/apps/web-client
      - /app/apps/web-client/node_modules

volumes:
  postgres_data:

networks:
  betstay-net:
    driver: bridge